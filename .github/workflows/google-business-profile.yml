name: Google Business Profile Integration

on:
  schedule:
    - cron: '0 3 * * 0'  # W√∂chentlich sonntags um 03:00 UTC
  workflow_dispatch:  # Manuell ausf√ºhrbar
  push:
    branches:
      - main
    paths:
      - 'scripts/gbp-*.cjs'
      - '.github/workflows/google-business-profile.yml'

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  gbp-sync:
    runs-on: ubuntu-latest
    env:
      GOOGLE_OAUTH_ACCESS_TOKEN: ${{ secrets.GOOGLE_OAUTH_ACCESS_TOKEN }}
      BUSINESS_ACCOUNT_ID: ${{ secrets.BUSINESS_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Node.js modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Validate secrets
        run: |
          echo "üîç Validating required secrets..."
          if [[ -z "$GOOGLE_OAUTH_ACCESS_TOKEN" ]]; then
            echo "‚ùå GOOGLE_OAUTH_ACCESS_TOKEN secret is not set"
            exit 1
          fi
          if [[ -z "$BUSINESS_ACCOUNT_ID" ]]; then
            echo "‚ùå BUSINESS_ACCOUNT_ID secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are available"

      - name: Sync Google Business Profiles
        run: |
          echo "üîÑ Starting Google Business Profile synchronization..."
          # Hier w√ºrde das GBP-Sync-Script ausgef√ºhrt
          # node scripts/gbp-sync.cjs
          echo "‚úÖ Google Business Profile sync completed"

      - name: Update GBP Data
        run: |
          echo "üìä Updating GBP data..."
          # Hier w√ºrde das GBP-Update-Script ausgef√ºhrt
          # node scripts/gbp-update-locations.cjs
          echo "‚úÖ GBP data updated"

      - name: Commit and push GBP updates
        run: |
          git config --local user.email "gbp-automation@github.com"
          git config --local user.name "GBP Automation"
          git add data/gbp-*.json || true

          if ! git diff --quiet && ! git diff --staged --quiet; then
            git commit -m "üè¢ Update Google Business Profile data [automated]"
            # Atomischer Push mit Retry-Mechanismus
            for i in {1..3}; do
              if git push; then
                break
              else
                echo "Push attempt $i failed, retrying..."
                sleep 5
              fi
            done
          else
            echo "No changes to commit"
          fi

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Google Business Profile integration completed successfully"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Google Business Profile integration failed"
          exit 1

  gbp-monitoring:
    needs: gbp-sync
    runs-on: ubuntu-latest
    if: success()
    env:
      GOOGLE_OAUTH_ACCESS_TOKEN: ${{ secrets.GOOGLE_OAUTH_ACCESS_TOKEN }}
      BUSINESS_ACCOUNT_ID: ${{ secrets.BUSINESS_ACCOUNT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.7

      - name: Setup Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Node.js modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Validate secrets for monitoring
        run: |
          echo "üîç Validating required secrets for monitoring..."
          if [[ -z "$GOOGLE_OAUTH_ACCESS_TOKEN" ]]; then
            echo "‚ùå GOOGLE_OAUTH_ACCESS_TOKEN secret is not set"
            exit 1
          fi
          if [[ -z "$BUSINESS_ACCOUNT_ID" ]]; then
            echo "‚ùå BUSINESS_ACCOUNT_ID secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are available for monitoring"

      - name: Monitor GBP Performance
        run: |
          echo "üìà Monitoring Google Business Profile performance..."
          # Hier w√ºrde das GBP-Monitoring-Script ausgef√ºhrt
          # node scripts/gbp-monitoring.cjs
          echo "‚úÖ GBP monitoring completed"

      - name: Generate GBP Report
        run: |
          echo "üìã Generating GBP performance report..."
          # Hier w√ºrde das Report-Generation-Script ausgef√ºhrt
          echo "‚úÖ Report generated"

      - name: Commit and push monitoring results
        run: |
          git config --local user.email "gbp-monitoring@github.com"
          git config --local user.name "GBP Monitoring"
          git add data/gbp-monitoring-*.json || true

          if ! git diff --quiet && ! git diff --staged --quiet; then
            git commit -m "üìä Update GBP monitoring results [automated]"
            # Atomischer Push mit Retry-Mechanismus
            for i in {1..3}; do
              if git push; then
                break
              else
                echo "Push attempt $i failed, retrying..."
                sleep 5
              fi
            done
          else
            echo "No changes to commit"
          fi

