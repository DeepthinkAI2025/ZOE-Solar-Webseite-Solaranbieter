name: Google Business Profile Integration

on:
  schedule:
    - cron: '0 3 * * 0'  # W√∂chentlich sonntags um 03:00 UTC
  workflow_dispatch:  # Manuell ausf√ºhrbar
  push:
    branches:
      - main
    paths:
      - 'scripts/gbp-*.cjs'
      - '.github/workflows/google-business-profile.yml'

jobs:
  gbp-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Sync Google Business Profiles
        env:
          GOOGLE_OAUTH_TOKEN: ${{ secrets.GOOGLE_OAUTH_TOKEN }}
          BUSINESS_ACCOUNT_ID: ${{ secrets.BUSINESS_ACCOUNT_ID }}
        run: |
          echo "üîÑ Starting Google Business Profile synchronization..."
          # Hier w√ºrde das GBP-Sync-Script ausgef√ºhrt
          # node scripts/gbp-sync.cjs
          echo "‚úÖ Google Business Profile sync completed"

      - name: Update GBP Data
        env:
          GOOGLE_OAUTH_TOKEN: ${{ secrets.GOOGLE_OAUTH_TOKEN }}
        run: |
          echo "üìä Updating GBP data..."
          # Hier w√ºrde das GBP-Update-Script ausgef√ºhrt
          # node scripts/gbp-update-locations.cjs
          echo "‚úÖ GBP data updated"

      - name: Commit and push GBP updates
        run: |
          git config --local user.email "gbp-automation@github.com"
          git config --local user.name "GBP Automation"
          git add data/gbp-*.json
          git commit -m "üè¢ Update Google Business Profile data [automated]" || echo "No changes to commit"
          git pull --rebase origin main
          git push

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Google Business Profile integration completed successfully"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Google Business Profile integration failed"
          exit 1

  gbp-monitoring:
    needs: gbp-sync
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Monitor GBP Performance
        env:
          GOOGLE_OAUTH_TOKEN: ${{ secrets.GOOGLE_OAUTH_TOKEN }}
        run: |
          echo "üìà Monitoring Google Business Profile performance..."
          # Hier w√ºrde das GBP-Monitoring-Script ausgef√ºhrt
          # node scripts/gbp-monitoring.cjs
          echo "‚úÖ GBP monitoring completed"

      - name: Generate GBP Report
        run: |
          echo "üìã Generating GBP performance report..."
          # Hier w√ºrde das Report-Generation-Script ausgef√ºhrt
          echo "‚úÖ Report generated"

      - name: Commit and push monitoring results
        run: |
          git config --local user.email "gbp-monitoring@github.com"
          git config --local user.name "GBP Monitoring"
          git add data/gbp-monitoring-*.json
          git commit -m "üìä Update GBP monitoring results [automated]" || echo "No changes to commit"
          git pull --rebase origin main
          git push

