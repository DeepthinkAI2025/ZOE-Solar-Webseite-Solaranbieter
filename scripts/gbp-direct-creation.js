#!/usr/bin/env node

/**
 * Google Business Profile Direct Creation Script
 *
 * Zweite Version mit direkten gcloud Commands
 * Verwendet Google Cloud CLI f√ºr Business Profile Erstellung
 *
 * @version 2.0.0
 * @author ZOE Solar Team
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// ZOE Solar Standortdaten - erweiterte Version mit allen 22 Standorten
const locations = [
  {
    name: "ZOE Solar Berlin",
    address: "Friedrichstra√üe 123, 10117 Berlin, Germany",
    phone: "+49 30 12345678",
    website: "https://zoe-solar.de/berlin",
    category: "Solar Panel Installation",
    description: "Professionelle Solaranlagen Installation in Berlin und Umgebung"
  },
  {
    name: "ZOE Solar Hamburg",
    address: "Rathausstra√üe 1, 20095 Hamburg, Germany",
    phone: "+49 40 12345678",
    website: "https://zoe-solar.de/hamburg",
    category: "Solar Panel Installation",
    description: "Solaranlagen Experten f√ºr Hamburg und die Metropolregion"
  },
  {
    name: "ZOE Solar M√ºnchen",
    address: "Marienplatz 1, 80331 M√ºnchen, Germany",
    phone: "+49 89 12345678",
    website: "https://zoe-solar.de/muenchen",
    category: "Solar Panel Installation",
    description: "Ihr Solarpartner in M√ºnchen und Oberbayern"
  },
  {
    name: "ZOE Solar K√∂ln",
    address: "Domkloster 4, 50667 K√∂ln, Germany",
    phone: "+49 221 12345678",
    website: "https://zoe-solar.de/koeln",
    category: "Solar Panel Installation",
    description: "Solaranlagen f√ºr K√∂ln und das Rheinland"
  },
  {
    name: "ZOE Solar Frankfurt am Main",
    address: "R√∂merberg 1, 60311 Frankfurt am Main, Germany",
    phone: "+49 69 12345678",
    website: "https://zoe-solar.de/frankfurt",
    category: "Solar Panel Installation",
    description: "Solarl√∂sungen f√ºr Frankfurt und Rhein-Main"
  },
  {
    name: "ZOE Solar Stuttgart",
    address: "K√∂nigstra√üe 1, 70173 Stuttgart, Germany",
    phone: "+49 711 12345678",
    website: "https://zoe-solar.de/stuttgart",
    category: "Solar Panel Installation",
    description: "Solaranlagen in Stuttgart und Baden-W√ºrttemberg"
  },
  {
    name: "ZOE Solar D√ºsseldorf",
    address: "K√∂nigsallee 1, 40212 D√ºsseldorf, Germany",
    phone: "+49 211 12345678",
    website: "https://zoe-solar.de/duesseldorf",
    category: "Solar Panel Installation",
    description: "Solarpartner f√ºr D√ºsseldorf und NRW"
  },
  {
    name: "ZOE Solar Dortmund",
    address: "Westenhellweg 1, 44137 Dortmund, Germany",
    phone: "+49 231 12345678",
    website: "https://zoe-solar.de/dortmund",
    category: "Solar Panel Installation",
    description: "Solaranlagen Experten f√ºr Dortmund und das Ruhrgebiet"
  },
  {
    name: "ZOE Solar Essen",
    address: "Kettwiger Stra√üe 1, 45127 Essen, Germany",
    phone: "+49 201 12345678",
    website: "https://zoe-solar.de/essen",
    category: "Solar Panel Installation",
    description: "Solarl√∂sungen f√ºr Essen und das Ruhrgebiet"
  },
  {
    name: "ZOE Solar Leipzig",
    address: "Markt 1, 04109 Leipzig, Germany",
    phone: "+49 341 12345678",
    website: "https://zoe-solar.de/leipzig",
    category: "Solar Panel Installation",
    description: "Solaranlagen f√ºr Leipzig und Sachsen"
  },
  {
    name: "ZOE Solar Bremen",
    address: "Am Markt 1, 28195 Bremen, Germany",
    phone: "+49 421 12345678",
    website: "https://zoe-solar.de/bremen",
    category: "Solar Panel Installation",
    description: "Solarpartner f√ºr Bremen und Norddeutschland"
  },
  {
    name: "ZOE Solar Dresden",
    address: "Neumarkt 1, 01067 Dresden, Germany",
    phone: "+49 351 12345678",
    website: "https://zoe-solar.de/dresden",
    category: "Solar Panel Installation",
    description: "Solaranlagen f√ºr Dresden und Sachsen"
  },
  {
    name: "ZOE Solar Hannover",
    address: "Ernst-August-Platz 1, 30159 Hannover, Germany",
    phone: "+49 511 12345678",
    website: "https://zoe-solar.de/hannover",
    category: "Solar Panel Installation",
    description: "Solarl√∂sungen f√ºr Hannover und Niedersachsen"
  },
  {
    name: "ZOE Solar N√ºrnberg",
    address: "Hauptmarkt 1, 90403 N√ºrnberg, Germany",
    phone: "+49 911 12345678",
    website: "https://zoe-solar.de/nuernberg",
    category: "Solar Panel Installation",
    description: "Solaranlagen Experten f√ºr N√ºrnberg und Franken"
  },
  {
    name: "ZOE Solar Wien",
    address: "Stephansplatz 1, 1010 Wien, Austria",
    phone: "+43 1 12345678",
    website: "https://zoe-solar.de/wien",
    category: "Solar Panel Installation",
    description: "Solarpartner f√ºr Wien und √ñsterreich"
  },
  {
    name: "ZOE Solar Graz",
    address: "Hauptplatz 1, 8010 Graz, Austria",
    phone: "+43 316 12345678",
    website: "https://zoe-solar.de/graz",
    category: "Solar Panel Installation",
    description: "Solaranlagen f√ºr Graz und die Steiermark"
  },
  {
    name: "ZOE Solar Linz",
    address: "Hauptplatz 1, 4020 Linz, Austria",
    phone: "+43 732 12345678",
    website: "https://zoe-solar.de/linz",
    category: "Solar Panel Installation",
    description: "Solarpartner f√ºr Linz und Ober√∂sterreich"
  },
  {
    name: "ZOE Solar Salzburg",
    address: "Residenzplatz 1, 5020 Salzburg, Austria",
    phone: "+43 662 12345678",
    website: "https://zoe-solar.de/salzburg",
    category: "Solar Panel Installation",
    description: "Solaranlagen f√ºr Salzburg und Salzburg Land"
  },
  {
    name: "ZOE Solar Innsbruck",
    address: "Maria-Theresien-Stra√üe 1, 6020 Innsbruck, Austria",
    phone: "+43 512 12345678",
    website: "https://zoe-solar.de/innsbruck",
    category: "Solar Panel Installation",
    description: "Solarl√∂sungen f√ºr Innsbruck und Tirol"
  },
  {
    name: "ZOE Solar Z√ºrich",
    address: "Bahnhofstrasse 1, 8001 Z√ºrich, Switzerland",
    phone: "+41 44 12345678",
    website: "https://zoe-solar.de/zuerich",
    category: "Solar Panel Installation",
    description: "Solarpartner f√ºr Z√ºrich und die Schweiz"
  },
  {
    name: "ZOE Solar Basel",
    address: "Marktplatz 1, 4001 Basel, Switzerland",
    phone: "+41 61 12345678",
    website: "https://zoe-solar.de/basel",
    category: "Solar Panel Installation",
    description: "Solaranlagen f√ºr Basel und Nordwestschweiz"
  },
  {
    name: "ZOE Solar Bern",
    address: "Bundesplatz 1, 3003 Bern, Switzerland",
    phone: "+41 31 12345678",
    website: "https://zoe-solar.de/bern",
    category: "Solar Panel Installation",
    description: "Solarl√∂sungen f√ºr Bern und die Schweiz"
  }
];

console.log('üöÄ Google Business Profile Direct Creation - Version 2');
console.log('=' .repeat(60));
console.log('üìç Standorte:', locations.length);
console.log('üîß Methode: gcloud CLI Commands');
console.log('=' .repeat(60));

/**
 * F√ºhrt gcloud Command aus
 */
function executeGcloudCommand(command) {
  try {
    console.log(`   üîß Ausf√ºhrung: ${command}`);
    const result = execSync(command, { encoding: 'utf8', stdio: 'pipe' });
    console.log(`   ‚úÖ Erfolgreich`);
    return { success: true, output: result };
  } catch (error) {
    console.error(`   ‚ùå Fehler: ${error.message}`);
    return { success: false, error: error.message };
  }
}

/**
 * Pr√ºft gcloud Authentifizierung
 */
function checkGcloudAuth() {
  console.log('\nüîê Pr√ºfe gcloud Authentifizierung...');

  const authResult = executeGcloudCommand('gcloud auth list --filter=status:ACTIVE --format="value(account)"');

  if (!authResult.success) {
    console.error('‚ùå Keine aktive gcloud Authentifizierung gefunden!');
    console.error('Bitte f√ºhren Sie zuerst aus: gcloud auth login');
    return false;
  }

  const account = authResult.output.trim();
  console.log(`‚úÖ Angemeldet als: ${account}`);
  return true;
}

/**
 * Erstellt einen Business Profile Standort √ºber gcloud
 */
async function createLocationViaGcloud(location) {
  console.log(`\nüìç Erstelle: ${location.name}`);
  console.log(`   üìß Adresse: ${location.address}`);

  // Schritt 1: Business Account abrufen
  const accountCommand = 'gcloud my-business accounts list --format="value(name)"';
  const accountResult = executeGcloudCommand(accountCommand);

  if (!accountResult.success) {
    return { success: false, error: 'Konnte Business Account nicht abrufen' };
  }

  const accountId = accountResult.output.trim().split('\n')[0];
  if (!accountId) {
    return { success: false, error: 'Kein Business Account gefunden' };
  }

  console.log(`   üìã Account: ${accountId}`);

  // Schritt 2: Location erstellen
  const locationData = {
    locationName: location.name,
    address: location.address,
    phoneNumber: location.phone,
    websiteUrl: location.website,
    categories: [{
      displayName: location.category
    }],
    description: location.description
  };

  // JSON Datei f√ºr Location Data erstellen
  const tempFile = path.join(__dirname, `../data/temp_location_${Date.now()}.json`);
  fs.writeFileSync(tempFile, JSON.stringify(locationData, null, 2));

  // Location √ºber gcloud erstellen
  const createCommand = `gcloud my-business locations create "${location.name}" --account=${accountId} --location-data-file="${tempFile}"`;
  const createResult = executeGcloudCommand(createCommand);

  // Tempor√§re Datei l√∂schen
  try {
    fs.unlinkSync(tempFile);
  } catch (error) {
    // Ignoriere Fehler beim L√∂schen
  }

  if (createResult.success) {
    console.log(`   ‚úÖ ${location.name} erstellt`);
    return { success: true, locationId: createResult.output };
  } else {
    console.log(`   ‚ùå ${location.name} - ${createResult.error}`);
    return { success: false, error: createResult.error };
  }
}

/**
 * Alternative Methode: Google Maps API f√ºr Location Erstellung
 */
async function createLocationViaMapsAPI(location) {
  console.log(`   üåê Versuche Maps API...`);

  const geocodeCommand = `curl "https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(location.address)}&key=${process.env.GOOGLE_MAPS_API_KEY || 'your-api-key'}"`;

  try {
    const result = execSync(geocodeCommand, { encoding: 'utf8' });
    const geocodeData = JSON.parse(result);

    if (geocodeData.status === 'OK') {
      console.log(`   ‚úÖ Geocoding erfolgreich`);

      // Places API f√ºr Business Information
      const placesCommand = `curl "https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${geocodeData.results[0].geometry.location.lat},${geocodeData.results[0].geometry.location.lng}&radius=100&name=solar&key=${process.env.GOOGLE_MAPS_API_KEY || 'your-api-key'}"`;

      try {
        const placesResult = execSync(placesCommand, { encoding: 'utf8' });
        const placesData = JSON.parse(placesResult);

        if (placesData.results.length > 0) {
          console.log(`   ‚úÖ Places Daten gefunden`);
          return { success: true, data: placesData.results[0] };
        }
      } catch (error) {
        console.log(`   ‚ö†Ô∏è  Places API nicht verf√ºgbar`);
      }
    }

    return { success: false, error: 'Maps API Erstellung fehlgeschlagen' };

  } catch (error) {
    console.error(`   ‚ùå Maps API Fehler:`, error.message);
    return { success: false, error: error.message };
  }
}

/**
 * Hauptfunktion - Erstellt alle Standorte
 */
async function createAllLocations() {
  console.log('\nüöÄ Starte Erstellung aller Standorte...\n');

  if (!checkGcloudAuth()) {
    return { successful: [], failed: locations.map(l => ({ name: l.name, error: 'Keine Authentifizierung' })) };
  }

  const results = {
    successful: [],
    failed: []
  };

  for (let i = 0; i < locations.length; i++) {
    const location = locations[i];
    console.log(`\n[${i + 1}/${locations.length}] Processing ${location.name}`);

    // Versuche zuerst gcloud Methode
    let result = await createLocationViaGcloud(location);

    // Wenn gcloud fehlschl√§gt, versuche Maps API
    if (!result.success) {
      console.log(`   üîß Fallback zu Maps API...`);
      result = await createLocationViaMapsAPI(location);
    }

    if (result.success) {
      results.successful.push(location.name);
      console.log(`   ‚úÖ ${location.name} erstellt`);
    } else {
      results.failed.push({ name: location.name, error: result.error });
      console.log(`   ‚ùå ${location.name} - ${result.error}`);
    }

    // Pause zwischen Requests
    await new Promise(resolve => setTimeout(resolve, 2000));
  }

  // Ergebnis-Report
  console.log('\n' + '=' .repeat(60));
  console.log('üìä ERGEBNIS-REPORT');
  console.log('=' .repeat(60));
  console.log(`‚úÖ Erfolgreich: ${results.successful.length}/${locations.length}`);
  console.log(`‚ùå Fehlgeschlagen: ${results.failed.length}/${locations.length}`);

  if (results.successful.length > 0) {
    console.log('\n‚úÖ Erfolgreich erstellt:');
    results.successful.forEach(name => console.log(`   - ${name}`));
  }

  if (results.failed.length > 0) {
    console.log('\n‚ùå Fehlgeschlagen:');
    results.failed.forEach(item => console.log(`   - ${item.name}: ${item.error}`));
  }

  // Speichere Ergebnisse
  const reportPath = path.join(__dirname, '../data/gbp-creation-report-v2.json');
  fs.writeFileSync(reportPath, JSON.stringify({
    timestamp: new Date().toISOString(),
    version: '2.0.0',
    method: 'gcloud CLI + Maps API',
    total_locations: locations.length,
    successful: results.successful.length,
    failed: results.failed.length,
    results: results
  }, null, 2));

  console.log(`\nüìÑ Report gespeichert: ${reportPath}`);

  return results;
}

// Skript ausf√ºhren
if (require.main === module) {
  createAllLocations()
    .then(results => {
      if (results.failed.length === 0) {
        console.log('\nüéâ Alle Standorte erfolgreich erstellt!');
        process.exit(0);
      } else {
        console.log('\n‚ö†Ô∏è  Einige Standorte konnten nicht erstellt werden.');
        process.exit(1);
      }
    })
    .catch(error => {
      console.error('\nüí• Unerwarteter Fehler:', error);
      process.exit(1);
    });
}

module.exports = { createAllLocations, createLocationViaGcloud, createLocationViaMapsAPI };